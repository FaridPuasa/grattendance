<!DOCTYPE html>
<html>
<head>
    <title>Sign In</title>
    
    <!-- Include the Bing Maps script -->
<script src="https://www.bing.com/api/maps/mapcontrol?key=AgkWMZlk5ts6xb8cJkzUar2iJMWTexduafRzsyANqeAF2b_PN0D2CZAKo8hfNqkB&callback=loadMapScenario" async defer></script>

</head>
<body>
    <h1>Sign In</h1>

    <!-- Add a div for the Bing Maps -->
    <div id="map" style="width: 50%; height: 400px;"></div>

   <!-- Form for sign-in -->
   <form id="signInForm" action="/signin" method="POST">
    <label for="username">Username:</label>
    <input type="text" name="username" required>
    <input type="hidden" id="latitude" name="latitude" value="" />
    <input type="hidden" id="longitude" name="longitude" value="" />
    <input type="hidden" id="location" name="location" value="" />
    <button type="button" onclick="getLocationAndSubmit()">Sign In</button>
</form>

    <!-- Your JavaScript for Bing Maps integration -->
    <script>

let map;

function loadMapScenario() {
    map = new Microsoft.Maps.Map(document.getElementById('map'), {
        credentials: 'AgkWMZlk5ts6xb8cJkzUar2iJMWTexduafRzsyANqeAF2b_PN0D2CZAKo8hfNqkB'
    });
}
        // Function to update the location fields in the form
        function updateLocationFields(latitude, longitude, address) {
            document.getElementById('latitude').value = latitude;
            document.getElementById('longitude').value = longitude;
            document.getElementById('location').value = address;
        }
    
 // Function to get the user's location
 function getLocationAndSubmit() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        // Set latitude and longitude values in the hidden input fields
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;

                       // Call function to perform reverse geocoding using Google Maps API
                       getAddressFromLatLng(latitude, longitude);

                        // Submit the form with obtained location
                        document.getElementById('signInForm').submit();
                    },
                    function (error) {
                        // Handle geolocation errors here (e.g., user denies permission)
                        console.error('Error getting location:', error);
                        alert('Error getting location. Please try again.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
// Function to perform reverse geocoding using Google Maps Geocoding API
function getAddressFromLatLng(latitude, longitude) {
    var latlng = new google.maps.LatLng(latitude, longitude);
    var geocoder = new google.maps.Geocoder();

    geocoder.geocode({ 'latLng': latlng }, function (results, status) {
        if (status === google.maps.GeocoderStatus.OK) {
            if (results[0]) {
                const address = results[0].formatted_address;
                updateLocationFields(latitude, longitude, address); // Update location fields with the retrieved address
            } else {
                updateLocationFields(latitude, longitude, 'Location not found'); // Handle case where location is not found
            }
        } else {
            updateLocationFields(latitude, longitude, 'Error fetching location'); // Handle error case
        }
    });
}
    </script>
</body>
</html>